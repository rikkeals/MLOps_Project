steps:

# TRAIN IMAGE
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build training image'
  args:
    - build
    - -f
    - dockerfiles/train.dockerfile
    - -t
    - europe-west1-docker.pkg.dev/$PROJECT_ID/mlops-project-group65-docker/train:latest
    - .

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push training image'
  args:
    - push
    - europe-west1-docker.pkg.dev/$PROJECT_ID/mlops-project-group65-docker/train:latest

# VERTEX
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
  id: 'Submit Vertex AI training job'
  entrypoint: bash
  args:
    - -c
    - |
      set -e
      IMAGE="${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/train:latest"
      OUTDIR="gs://${_BUCKET}/models/vertex-${BUILD_ID}"

      echo "Submitting Vertex AI training job"
      echo "Image: $${IMAGE}"
      echo "Output: $${OUTDIR}"

      gcloud ai custom-jobs create \
        --region="${_REGION}" \
        --display-name="nnunet-train-${BUILD_ID}" \
        --worker-pool-spec=machine-type=n1-standard-8,replica-count=1,container-image-uri="$${IMAGE}",container-command=python,container-args="-m,mlops_project.train,dataset.dataset_id=621,training.device=cpu,paths.gcs_output=$${OUTDIR}"

# API IMAGE
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build api image'
  args:
    - build
    - -f
    - dockerfiles/api.dockerfile
    - -t
    - europe-west1-docker.pkg.dev/$PROJECT_ID/mlops-project-group65-docker/api:latest
    - .

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push api image'
  args:
    - push
    - europe-west1-docker.pkg.dev/$PROJECT_ID/mlops-project-group65-docker/api:latest

# Deploy cloud run service
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy API to Cloud Run'
  args:
    - run
    - deploy
    - ${_SERVICE}
    - --image
    - europe-west1-docker.pkg.dev/$PROJECT_ID/mlops-project-group65-docker/api:latest
    - --region
    - europe-west1
    - --platform
    - managed
    - --allow-unauthenticated
    - --port
    - "8080"
    - --memory
    - "4Gi"

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: europe-west1
  _REPO: mlops-project-group65-docker
  _SERVICE: mlops-api
  _BUCKET: mlops-project-group65-data